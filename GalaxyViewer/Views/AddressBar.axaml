<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialIcons="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
             xmlns:viewModels="clr-namespace:GalaxyViewer.ViewModels"
             xmlns:converters="clr-namespace:GalaxyViewer.Converters"
             x:Class="GalaxyViewer.Controls.AddressBar"
             x:DataType="viewModels:AddressBarViewModel">

    <UserControl.Resources>
        <converters:BoolToDoubleConverter x:Key="BoolToDoubleConverter" />
    </UserControl.Resources>

    <!-- Custom Styles for AddressBar using accent color -->
    <UserControl.Styles>
        <!-- Address bar button styling -->
        <Style Selector="Button.address-bar-button">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="8" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Foreground" Value="{DynamicResource SystemAccentColorBrush}" />
        </Style>
        <Style Selector="Button.address-bar-button:pointerover">
            <Setter Property="Background" Value="{DynamicResource SystemControlForegroundBaseLowBrush}" />
        </Style>
        <Style Selector="Button.address-bar-button:pressed">
            <Setter Property="Background" Value="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
        </Style>

        <!-- Address display styling -->
        <Style Selector="Border.address-display">
            <Setter Property="Background" Value="{DynamicResource SystemControlBackgroundChromeMediumBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource SystemControlForegroundBaseLowBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Margin" Value="8,0" />
        </Style>
        <Style Selector="Border.address-display:focus-within">
            <Setter Property="BorderBrush" Value="{DynamicResource SystemAccentColorBrush}" />
            <Setter Property="BorderThickness" Value="2" />
        </Style>

        <!-- Address bar container styling -->
        <Style Selector="Border.address-bar-container">
            <Setter Property="Background" Value="{DynamicResource CardBackground}" />
            <Setter Property="BorderBrush" Value="{DynamicResource SystemControlForegroundBaseLowBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Padding" Value="4" />
        </Style>
    </UserControl.Styles>

    <UserControl.KeyBindings>
        <KeyBinding Gesture="Enter" Command="{Binding CommitEditCommand}" />
    </UserControl.KeyBindings>

    <OnPlatform>
        <On Options="Android">
            <Border Classes="address-bar-container">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="4">
                    <Border Width="18" Height="18"
                            CornerRadius="9"
                            Margin="0,0,8,0"
                            VerticalAlignment="Center"
                            Background="{Binding MaturityRatingBrush}"
                            IsVisible="{Binding ShowMaturityRating}"
                            ToolTip.Tip="{Binding MaturityRatingTooltip}"
                            AutomationProperties.Name="{Binding MaturityRatingTooltip}">
                        <TextBlock Text="{Binding MaturityRating}"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   FontSize="10"
                                   FontWeight="Bold"
                                   Foreground="White" />
                    </Border>
                    <Button Background="Transparent"
                            BorderThickness="0"
                            Padding="0"
                            VerticalAlignment="Center"
                            HorizontalAlignment="Left"
                            Command="{Binding StartEditCommand}"
                            IsVisible="{Binding IsEditing, Converter={StaticResource InverseBoolConverter}}"
                            AutomationProperties.Name="Current location, tap to edit">
                        <TextBlock Text="{Binding CurrentLocationDisplay}"
                                   VerticalAlignment="Center"
                                   Margin="4,2,0,2"
                                   FontSize="14"
                                   Foreground="{DynamicResource SystemAccentColorBrush}" />
                    </Button>
                    <TextBox Text="{Binding EditableLocation, Mode=TwoWay}"
                             VerticalAlignment="Center"
                             Margin="4,2,0,2"
                             FontSize="14"
                             Background="Transparent"
                             BorderThickness="0"
                             Watermark="{Binding CurrentLocationDisplay}"
                             Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"
                             SelectionBrush="{DynamicResource SystemControlHighlightAccentBrush}"
                             CaretBrush="{DynamicResource SystemControlForegroundBaseHighBrush}"
                             AutomationProperties.Name="{StaticResource AddressBar_Edit_A11y}"
                             HorizontalAlignment="Stretch"
                             MinWidth="0"
                             MaxWidth="10000"
                             IsVisible="{Binding IsEditing}"
                             Focusable="True"
                             GotFocus="EditTextBox_GotFocus" />
                    <Button Content="âœ•"
                            Margin="4,0,4,0"
                            VerticalAlignment="Center"
                            IsVisible="{Binding IsEditing}"
                            Command="{Binding CancelEditCommand}"
                            ToolTip.Tip="{StaticResource AddressBar_Cancel_Tooltip}"
                            MinWidth="32"
                            MinHeight="32" />
                    <Button Content="{DynamicResource AddressBar_Go_Button}"
                            Margin="4,0,0,0"
                            VerticalAlignment="Center"
                            IsVisible="{Binding IsEditing}"
                            Command="{Binding CommitEditCommand}"
                            ToolTip.Tip="{StaticResource AddressBar_Go_Tooltip}"
                            MinWidth="32"
                            MinHeight="32" />
                </StackPanel>
            </Border>
        </On>
        <On Options="Default">
            <Border Classes="address-bar-container">
                <Grid ColumnDefinitions="Auto,Auto,Auto,*,Auto,Auto">

                    <!-- Home Button -->
                    <Button Grid.Column="0"
                            Classes="address-bar-button"
                            Command="{Binding HomeCommand}"
                            ToolTip.Tip="{StaticResource AddressBar_Home_Tooltip}"
                            Margin="4"
                            AutomationProperties.Name="{StaticResource AddressBar_Home_A11y}">
                        <materialIcons:MaterialIconExt Kind="Home" />
                    </Button>

                    <!-- Navigation Button Group -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="0">
                        <!-- Back Button -->
                        <Button Classes="address-bar-button"
                                Command="{Binding BackCommand}"
                                IsEnabled="{Binding CanGoBack}"
                                ToolTip.Tip="{StaticResource AddressBar_Back_Tooltip}"
                                Margin="2,4"
                                AutomationProperties.Name="{StaticResource AddressBar_Back_A11y}"
                                Opacity="{Binding CanGoBack, Converter={StaticResource BoolToDoubleConverter}, ConverterParameter='1.0 0.4'}">
                            <materialIcons:MaterialIconExt Kind="ArrowBack" />
                        </Button>

                        <!-- Forward Button -->
                        <Button Classes="address-bar-button"
                                Command="{Binding ForwardCommand}"
                                IsEnabled="{Binding CanGoForward}"
                                ToolTip.Tip="{StaticResource AddressBar_Forward_Tooltip}"
                                Margin="2,4"
                                AutomationProperties.Name="{StaticResource AddressBar_Forward_A11y}"
                                Opacity="{Binding CanGoForward, Converter={StaticResource BoolToDoubleConverter}, ConverterParameter='1.0 0.4'}">
                            <materialIcons:MaterialIconExt Kind="ArrowForward" />
                        </Button>
                    </StackPanel>

                    <!-- Address Display/Editor -->
                    <Border Grid.Column="3" Classes="address-display">
                        <Grid>
                            <!-- Read-only current location display -->
                            <Button Command="{Binding StartEditCommand}"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    HorizontalAlignment="Stretch"
                                    HorizontalContentAlignment="Left"
                                    VerticalContentAlignment="Center"
                                    Padding="8,4"
                                    AutomationProperties.Name="Current location, click to edit"
                                    IsVisible="{Binding IsEditing, Converter={x:Static BoolConverters.Not}}">

                                <StackPanel Orientation="Horizontal">
                                    <!-- Maturity Rating Badge -->
                                    <Border Width="18" Height="18"
                                            CornerRadius="9"
                                            Margin="0,0,8,0"
                                            VerticalAlignment="Center"
                                            Background="{Binding MaturityRatingBrush}"
                                            IsVisible="{Binding ShowMaturityRating}"
                                            ToolTip.Tip="{Binding MaturityRatingTooltip}"
                                            AutomationProperties.Name="{Binding MaturityRatingTooltip}">
                                        <TextBlock Text="{Binding MaturityRating}"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center"
                                                   FontSize="10"
                                                   FontWeight="Bold"
                                                   Foreground="White" />
                                    </Border>

                                    <!-- Current Location Text -->
                                    <TextBlock Text="{Binding CurrentLocationDisplay}"
                                               VerticalAlignment="Center"
                                               FontSize="14"
                                               Foreground="{DynamicResource SystemAccentColorBrush}"
                                               FontWeight="Medium" />
                                </StackPanel>
                            </Button>

                            <!-- Edit Mode -->
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center"
                                        HorizontalAlignment="Stretch">
                                <TextBox x:Name="EditTextBox"
                                         Text="{Binding EditableLocation, Mode=TwoWay}"
                                         VerticalAlignment="Center"
                                         Margin="8,2,0,2"
                                         FontSize="14"
                                         Background="Transparent"
                                         BorderThickness="0"
                                         Watermark="{StaticResource AddressBar_Edit_Watermark}"
                                         Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                         SelectionBrush="{DynamicResource SystemControlHighlightAccentBrush}"
                                         CaretBrush="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                         AutomationProperties.Name="{StaticResource AddressBar_Edit_A11y}"
                                         IsVisible="{Binding IsEditing}"
                                         HorizontalAlignment="Stretch">
                                    <TextBox.KeyBindings>
                                        <KeyBinding Gesture="Enter" Command="{Binding CommitEditCommand}" />
                                        <KeyBinding Gesture="Escape" Command="{Binding CancelEditCommand}" />
                                    </TextBox.KeyBindings>
                                    <TextBox.Styles>
                                        <Style Selector="TextBox /template/ TextBlock#PART_Watermark">
                                            <Setter Property="Opacity" Value="0.5" />
                                            <Setter Property="FontWeight" Value="Normal" />
                                        </Style>
                                        <Style Selector="TextBox:focus /template/ TextBlock#PART_Watermark">
                                            <Setter Property="Opacity" Value="0.5" />
                                        </Style>
                                    </TextBox.Styles>
                                </TextBox>
                                <Button Content="âœ•"
                                        Margin="16,0,0,0"
                                        VerticalAlignment="Center"
                                        IsVisible="{Binding IsEditing}"
                                        Command="{Binding CancelEditCommand}"
                                        ToolTip.Tip="{StaticResource AddressBar_Cancel_Tooltip}"
                                        MinWidth="32"
                                        MinHeight="32" />
                                <Button Content="{DynamicResource AddressBar_Go_Button}"
                                        Margin="4,0,0,0"
                                        VerticalAlignment="Center"
                                        IsVisible="{Binding IsEditing}"
                                        Command="{Binding CommitEditCommand}"
                                        ToolTip.Tip="{StaticResource AddressBar_Go_Tooltip}"
                                        MinWidth="32"
                                        MinHeight="32" />
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Action Buttons Group -->
                    <StackPanel Grid.Column="4" Orientation="Horizontal" Spacing="0">
                        <!-- Search/Go Button -->
                        <Button Classes="address-bar-button"
                                Command="{Binding CommitEditCommand}"
                                Foreground="{StaticResource SystemAccentColor}"
                                ToolTip.Tip="{StaticResource AddressBar_Go_Tooltip}"
                                Margin="2,4"
                                AutomationProperties.Name="{StaticResource AddressBar_Go_A11y}">
                            <materialIcons:MaterialIconExt Kind="Search" />
                        </Button>

                        <!-- Settings Button -->
                        <Button Classes="address-bar-button"
                                Command="{Binding SettingsCommand}"
                                Foreground="{StaticResource SystemAccentColor}"
                                ToolTip.Tip="{StaticResource AddressBar_Settings_Tooltip}"
                                Margin="4"
                                AutomationProperties.Name="{StaticResource AddressBar_Settings_A11y}">
                            <materialIcons:MaterialIconExt Kind="Settings" />
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>
        </On>
    </OnPlatform>
</UserControl>